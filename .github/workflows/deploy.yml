name: Build and Deploy

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        service: [backend, frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Set owner to lowercase
        run: echo "OWNER_LC=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_ENV"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - name: Build & push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile
          platforms: linux/amd64
          push: true
          tags: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}-${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.AZURE_VM_SSH_KEY }}

      - name: Deploy to Azure VM
        shell: bash
        env:
          AZ_USER: ${{ secrets.AZURE_VM_USERNAME }}
          AZ_HOST: ${{ secrets.AZURE_VM_HOST }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          REGISTRY: docker.io
          IMAGE_NAME: ${{ github.event.repository.name }}
          IMAGE_TAG: latest
        run: |
          set -euo pipefail

          if [[ -f "$GITHUB_WORKSPACE/docker-compose.yml" ]]; then
            SRC_COMPOSE="$GITHUB_WORKSPACE/docker-compose.yml"
          elif [[ -f "$GITHUB_WORKSPACE/deploy/docker-compose.yml" ]]; then
            SRC_COMPOSE="$GITHUB_WORKSPACE/deploy/docker-compose.yml"
          else
            echo "docker-compose.yml not found"; exit 1
          fi

          ssh -o StrictHostKeyChecking=no "${AZ_USER}@${AZ_HOST}" "mkdir -p ~/Quantimizer-System"
          scp -o StrictHostKeyChecking=no "${SRC_COMPOSE}" "${AZ_USER}@${AZ_HOST}:~/Quantimizer-System/docker-compose.yml"

          ssh -o StrictHostKeyChecking=no "${AZ_USER}@${AZ_HOST}" bash -s <<EOF
          set -euo pipefail

          if ! command -v docker >/dev/null 2>&1; then
            curl -fsSL https://get.docker.com | sh
            sudo usermod -aG docker \$USER || true
          fi
          if ! docker compose version >/dev/null 2>&1; then
            sudo apt-get update -y && sudo apt-get install -y docker-compose-plugin || true
          fi

          cd ~/Quantimizer-System

          export REGISTRY="${REGISTRY}"
          export IMAGE_NS="${DOCKERHUB_USERNAME}"
          export IMAGE_NAME="${IMAGE_NAME}"
          export IMAGE_TAG="${IMAGE_TAG}"

          echo "\$DOCKERHUB_TOKEN" | docker login "\$REGISTRY" -u "\$IMAGE_NS" --password-stdin

          docker compose -f docker-compose.yml config

          for s in backend frontend; do
            REF="\$REGISTRY/\$IMAGE_NS/\$IMAGE_NAME-\$s:\$IMAGE_TAG"
            docker manifest inspect "\$REF" >/dev/null 2>&1 || { echo "manifest missing: \$REF"; exit 1; }
          done

          docker compose -f docker-compose.yml pull
          docker compose -f docker-compose.yml up -d
          docker image prune -f || true
          EOF
